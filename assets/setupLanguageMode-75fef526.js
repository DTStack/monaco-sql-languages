import{k as v,b9 as C,ba as y,bb as E,bc as M,bd as m}from"./index-09b6a538.js";function L(i,e,o){let l=null;return(...s)=>{if(l&&clearTimeout(l),o&&!l)return i==null?void 0:i(...s);l=setTimeout(()=>{l&&clearTimeout(l),l=null,i==null||i(...s)},e)}}class N{constructor(e,o,l){this._languageId=e,this._worker=o,this._defaults=l,this._disposables=[],this._listener=Object.create(null);const s=n=>{let t=n.getLanguageId();t===this._languageId&&(this._listener[n.uri.toString()]=n.onDidChangeContent(L(()=>{this._doValidate(n.uri,t)},500)),this._doValidate(n.uri,t))},u=n=>{v.setModelMarkers(n,this._languageId,[]);let t=n.uri.toString(),r=this._listener[t];r&&(r.dispose(),delete this._listener[t])};this._disposables.push(v.onDidCreateModel(s)),this._disposables.push(v.onWillDisposeModel(u)),this._disposables.push(v.onDidChangeModelLanguage(n=>{u(n.model),s(n.model)})),this._disposables.push(this._defaults.onDidChange(n=>{v.getModels().forEach(t=>{t.getLanguageId()===this._languageId&&(u(t),s(t))})})),this._disposables.push({dispose:()=>{for(let n in this._listener)this._listener[n].dispose()}}),v.getModels().forEach(s)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,o){this._worker(e).then(l=>{var s;let u=((s=v.getModel(e))===null||s===void 0?void 0:s.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(u=this._defaults.preprocessCode(u)),l.doValidation(u)}).then(l=>{const s=l.map(n=>P(e,n));let u=v.getModel(e);u&&u.getLanguageId()===o&&v.setModelMarkers(u,o,s)}).then(void 0,l=>{console.error(l)})}}function D(i){switch(i){default:return E.Error}}function P(i,e){return{severity:D(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class V{constructor(e,o){this._worker=e,this._defaults=o}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(e,o,l,s){const u=e.uri;return this._worker(u).then(n=>{var t;let r=((t=v.getModel(u))===null||t===void 0?void 0:t.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(r=this._defaults.preprocessCode(r)),n.doCompletionWithEntities(r,o)}).then(({suggestions:n,allEntities:t,context:r})=>{let p=[];return r!=null&&r.isStatementBeginning&&(p=this._defaults.completionSnippets.map(d=>Object.assign(Object.assign({},d),{insertText:typeof d.body=="string"?d.body:d.body.join(`
`)}))),this._defaults.completionService(e,o,l,n,t,p)}).then(n=>{const t=e.getWordUntilPosition(o),r=new C(o.lineNumber,t.startColumn,o.lineNumber,t.endColumn);return{suggestions:(Array.isArray(n)?n:n.suggestions).map(a=>{var c,g;return Object.assign(Object.assign({},a),{insertText:(c=a.insertText)!==null&&c!==void 0?c:typeof a.label=="string"?a.label:a.label.label,range:(g=a.range)!==null&&g!==void 0?g:r})}),dispose:Array.isArray(n)?void 0:n.dispose,incomplete:Array.isArray(n)?void 0:n.incomplete}})}}class W{constructor(e,o){this._worker=e,this._defaults=o}provideDefinition(e,o,l){const s=e.uri;return e.getLineContent(o.lineNumber).startsWith("--")?null:this._worker(s).then(n=>{let t=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(t=this._defaults.preprocessCode(t)),n.getAllEntities(t)}).then(n=>{const t=e.getWordAtPosition(o);let r={line:-1,startIndex:-1,endIndex:-1,startColumn:-1,endColumn:-1};const p=n==null?void 0:n.find(d=>{const a=d.position;return a.startColumn===(t==null?void 0:t.startColumn)&&a.endColumn===(t==null?void 0:t.endColumn)&&a.line===o.lineNumber?d:null});if(p)for(let d in n){const a=n[Number(d)];if(a.entityContextType.includes("Create")&&(t!=null&&t.word)&&a.text===(t==null?void 0:t.word)&&a.entityContextType.includes(p.entityContextType)){r=a.position;break}}if(r&&r.line!==-1)return{uri:e.uri,range:new C(r==null?void 0:r.line,r==null?void 0:r.startColumn,r==null?void 0:r.line,r==null?void 0:r.endColumn)}})}}class R{constructor(e,o){this._worker=e,this._defaults=o}provideReferences(e,o,l,s){const u=e.uri;if(e.getLineContent(o.lineNumber).startsWith("CREATE"))return this._worker(u).then(t=>{let r=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(r=this._defaults.preprocessCode(r)),t.getAllEntities(e==null?void 0:e.getValue())}).then(t=>{const r=e.getWordAtPosition(o),p=[],d=t==null?void 0:t.find(a=>{const c=a.position;return c.startColumn===(r==null?void 0:r.startColumn)&&c.endColumn===(r==null?void 0:r.endColumn)&&c.line===o.lineNumber?a:null});return d&&(t==null||t.forEach(a=>{if(r!=null&&r.word&&a.text===(r==null?void 0:r.word)&&d.entityContextType.includes(a.entityContextType)){let c=null;c=a.position,p.push({uri:e.uri,range:new C(c==null?void 0:c.line,c==null?void 0:c.startColumn,c==null?void 0:c.line,c==null?void 0:c.endColumn)})}})),p})}}class S{constructor(e,o){this._worker=e,this._defaults=o}provideHover(e,o,l){const s=e.uri;return e.getLineContent(o.lineNumber).trim().startsWith("--")?null:this._worker(s).then(n=>{let t=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(t=this._defaults.preprocessCode(t)),n.getAllEntities(t,o)}).then(n=>{var t,r;if(!n||!n.length)return null;let p=!1;const d=n.find(h=>{const _=h.position,f=h._alias;return p=!!(f&&f.startColumn<=o.column&&f.endColumn>=o.column&&f.line===o.lineNumber),_.startColumn<=o.column&&_.endColumn>=o.column&&_.line===o.lineNumber||p});if(!d)return null;const a=$(d,n),g=(a?j(a)||[]:[]).reduce((h,_)=>{const{column:f,type:w,comment:x,alias:A}=_;return h+`\`${f}\` ${w?`&nbsp;&nbsp; **${w}**`:""} ${x?`&nbsp;&nbsp; *${x}*`:""} ${A?`&nbsp;&nbsp; *${A}*`:""} 
`},""),I=p&&(r=(t=d._alias)===null||t===void 0?void 0:t.text)!==null&&r!==void 0?r:d.text;let b;if(p&&d._alias)b=new C(d._alias.line,d._alias.startColumn,d._alias.line,d._alias.endColumn);else{const h=d.position;b=new C(h.line,h.startColumn,h.line,h.endColumn)}return{contents:[{value:`**${I}**`},{value:g}],range:b}})}}function $(i,e){var o;if(typeof i!="string"&&i.entityContextType!==y.TABLE)return null;const l=typeof i=="string"?i:i.text;function s(u){return u.replace(/^['"`“”‘’«»]|['"`“”‘’«»]$/g,"")}return(o=e.find(u=>u.entityContextType===y.TABLE_CREATE&&s(u.text)===s(l)))!==null&&o!==void 0?o:null}function j(i){var e;if(!i||i.entityContextType!==y.TABLE_CREATE||!(!((e=i.columns)===null||e===void 0)&&e.length))return null;const o=[];return i.columns.forEach(l=>{var s,u,n;o.push({column:l.text,type:(s=l._colType)===null||s===void 0?void 0:s.text,comment:(u=l._comment)===null||u===void 0?void 0:u.text,alias:(n=l._alias)===null||n===void 0?void 0:n.text})}),o}function H(i){const e=[],o=[],l=new M(i);e.push(l);const s=(...n)=>l.getLanguageServiceWorker(...n);function u(){const{languageId:n,modeConfiguration:t}=i;T(o),t.diagnostics&&o.push(new N(n,s,i)),t.completionItems.enable&&o.push(m.registerCompletionItemProvider(n,new V(s,i))),t.references&&o.push(m.registerReferenceProvider(n,new R(s,i))),t.definitions&&o.push(m.registerDefinitionProvider(n,new W(s,i))),t.hover&&o.push(m.registerHoverProvider(n,new S(s,i)))}return u(),e.push(k(o)),k(e)}function k(i){return{dispose:()=>T(i)}}function T(i){for(var e;i.length;)(e=i.pop())===null||e===void 0||e.dispose()}export{H as setupLanguageMode};

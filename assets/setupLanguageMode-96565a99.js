import{e as a,R as v,l as h,d as f,M as b,W as C}from"./index-f81ab3ba.js";class I{constructor(e,s,i){this._languageId=e,this._worker=s,this._disposables=[],this._listener=Object.create(null);const n=t=>{let o=t.getLanguageId();o===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(f(()=>{this._doValidate(t.uri,o)},600)),this._doValidate(t.uri,o))},l=t=>{a.setModelMarkers(t,this._languageId,[]);let o=t.uri.toString(),u=this._listener[o];u&&(u.dispose(),delete this._listener[o])};this._disposables.push(a.onDidCreateModel(n)),this._disposables.push(a.onWillDisposeModel(l)),this._disposables.push(a.onDidChangeModelLanguage(t=>{l(t.model),n(t.model)})),i.onDidChange(t=>{a.getModels().forEach(o=>{o.getLanguageId()===this._languageId&&(l(o),n(o))})}),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),a.getModels().forEach(n)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,s){this._worker(e).then(i=>{var n;return i.doValidation(((n=a.getModel(e))===null||n===void 0?void 0:n.getValue())||"")}).then(i=>{const n=i.map(t=>k(e,t));let l=a.getModel(e);l&&l.getLanguageId()===s&&a.setModelMarkers(l,s,n)}).then(void 0,i=>{console.error(i)})}}function M(r){switch(r){default:return b.Error}}function k(r,e){let s=typeof e.code=="number"?String(e.code):e.code;return console.log(e),{severity:M(e.severity),startLineNumber:e.startLine,startColumn:e.startCol+1,endLineNumber:e.endLine,endColumn:e.endCol+1,message:e.message,code:s,source:e.source}}class w{constructor(e,s){this._worker=e,this._defaults=s}get triggerCharacters(){return["."," "]}provideCompletionItems(e,s,i,n){const l=e.uri;return this._worker(l).then(t=>{var o;return t.doComplete(((o=a.getModel(l))===null||o===void 0?void 0:o.getValue())||"",s)}).then(t=>(typeof this._defaults.completionService=="function"?this._defaults.completionService:S)(e,s,i,t)).then(t=>{const o=e.getWordUntilPosition(s),u=new v(s.lineNumber,o.startColumn,s.lineNumber,o.endColumn);return{suggestions:t.map(d=>{var c,p,g;return Object.assign(Object.assign({},d),{insertText:(c=d.insertText)!==null&&c!==void 0?c:typeof d.label=="string"?d.label:d.label.label,range:(p=d.range)!==null&&p!==void 0?p:u,insertTextRules:(g=d.insertTextRules)!==null&&g!==void 0?g:h.CompletionItemInsertTextRule.InsertAsSnippet})})}})}}const S=function(r,e,s,i){if(!i)return Promise.resolve([]);const{keywords:n}=i,l=n.map(t=>({label:t,kind:h.CompletionItemKind.Keyword,detail:"keyword"}));return Promise.resolve(l)};function D(r){const e=[],s=[],i=new C(r);e.push(i);const n=(...t)=>i.getLanguageServiceWorker(...t);function l(){const{languageId:t,modeConfiguration:o}=r;m(s),o.diagnostics&&s.push(new I(t,n,r)),o.completionItems&&s.push(h.registerCompletionItemProvider(t,new w(n,r)))}return l(),e.push(_(s)),_(e)}function _(r){return{dispose:()=>m(r)}}function m(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{D as setupLanguageMode};

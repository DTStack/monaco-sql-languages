import{e as a,R as f,l as h,d as v,M as b,W as C}from"./index-30506603.js";class I{constructor(e,n,i){this._languageId=e,this._worker=n,this._disposables=[],this._listener=Object.create(null);const o=t=>{let s=t.getLanguageId();s===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(v(()=>{this._doValidate(t.uri,s)},600)),this._doValidate(t.uri,s))},l=t=>{a.setModelMarkers(t,this._languageId,[]);let s=t.uri.toString(),u=this._listener[s];u&&(u.dispose(),delete this._listener[s])};this._disposables.push(a.onDidCreateModel(o)),this._disposables.push(a.onWillDisposeModel(l)),this._disposables.push(a.onDidChangeModelLanguage(t=>{l(t.model),o(t.model)})),i.onDidChange(t=>{a.getModels().forEach(s=>{s.getLanguageId()===this._languageId&&(l(s),o(s))})}),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),a.getModels().forEach(o)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,n){this._worker(e).then(i=>{var o;return i.doValidation(((o=a.getModel(e))===null||o===void 0?void 0:o.getValue())||"")}).then(i=>{const o=i.map(t=>k(e,t));let l=a.getModel(e);l&&l.getLanguageId()===n&&a.setModelMarkers(l,n,o)}).then(void 0,i=>{console.error(i)})}}function M(r){switch(r){default:return b.Error}}function k(r,e){return{severity:M(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class w{constructor(e,n){this._worker=e,this._defaults=n}get triggerCharacters(){return["."," "]}provideCompletionItems(e,n,i,o){const l=e.uri;return this._worker(l).then(t=>{var s;return t.doComplete(((s=a.getModel(l))===null||s===void 0?void 0:s.getValue())||"",n)}).then(t=>(typeof this._defaults.completionService=="function"?this._defaults.completionService:S)(e,n,i,t)).then(t=>{const s=e.getWordUntilPosition(n),u=new f(n.lineNumber,s.startColumn,n.lineNumber,s.endColumn);return{suggestions:t.map(d=>{var c,g,p;return Object.assign(Object.assign({},d),{insertText:(c=d.insertText)!==null&&c!==void 0?c:typeof d.label=="string"?d.label:d.label.label,range:(g=d.range)!==null&&g!==void 0?g:u,insertTextRules:(p=d.insertTextRules)!==null&&p!==void 0?p:h.CompletionItemInsertTextRule.InsertAsSnippet})})}})}}const S=function(r,e,n,i){if(!i)return Promise.resolve([]);const{keywords:o}=i,l=o.map(t=>({label:t,kind:h.CompletionItemKind.Keyword,detail:"keyword"}));return Promise.resolve(l)};function D(r){const e=[],n=[],i=new C(r);e.push(i);const o=(...t)=>i.getLanguageServiceWorker(...t);function l(){const{languageId:t,modeConfiguration:s}=r;m(n),s.diagnostics&&n.push(new I(t,o,r)),s.completionItems&&n.push(h.registerCompletionItemProvider(t,new w(o,r)))}return l(),e.push(_(n)),_(e)}function _(r){return{dispose:()=>m(r)}}function m(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{D as setupLanguageMode};

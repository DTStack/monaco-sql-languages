import{e as d,R as _,d as f,M as C,W as b,l as v}from"./index-f9d9330f.js";class m{constructor(s,r,a){this._languageId=s,this._worker=r,this._defaults=a,this._disposables=[],this._listener=Object.create(null);const o=e=>{let t=e.getLanguageId();t===this._languageId&&(this._listener[e.uri.toString()]=e.onDidChangeContent(f(()=>{this._doValidate(e.uri,t)},500)),this._doValidate(e.uri,t))},n=e=>{d.setModelMarkers(e,this._languageId,[]);let t=e.uri.toString(),l=this._listener[t];l&&(l.dispose(),delete this._listener[t])};this._disposables.push(d.onDidCreateModel(o)),this._disposables.push(d.onWillDisposeModel(n)),this._disposables.push(d.onDidChangeModelLanguage(e=>{n(e.model),o(e.model)})),this._disposables.push(this._defaults.onDidChange(e=>{d.getModels().forEach(t=>{t.getLanguageId()===this._languageId&&(n(t),o(t))})})),this._disposables.push({dispose:()=>{for(let e in this._listener)this._listener[e].dispose()}}),d.getModels().forEach(o)}dispose(){this._disposables.forEach(s=>s&&s.dispose()),this._disposables=[]}_doValidate(s,r){this._worker(s).then(a=>{var o;let n=((o=d.getModel(s))===null||o===void 0?void 0:o.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(n=this._defaults.preprocessCode(n)),a.doValidation(n)}).then(a=>{const o=a.map(e=>w(s,e));let n=d.getModel(s);n&&n.getLanguageId()===r&&d.setModelMarkers(n,r,o)}).then(void 0,a=>{console.error(a)})}}function M(i){switch(i){default:return C.Error}}function w(i,s){return{severity:M(),startLineNumber:s.startLine,startColumn:s.startColumn,endLineNumber:s.endLine,endColumn:s.endColumn,message:s.message,code:void 0,source:"dt-sql-parser"}}class y{constructor(s,r){this._worker=s,this._defaults=r}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(s,r,a,o){const n=s.uri;return this._worker(n).then(e=>{var t;let l=((t=d.getModel(n))===null||t===void 0?void 0:t.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(l=this._defaults.preprocessCode(l)),e.doCompletionWithEntities(l,r)}).then(([e,t])=>this._defaults.completionService(s,r,a,e,t)).then(e=>{const t=s.getWordUntilPosition(r),l=new _(r.lineNumber,t.startColumn,r.lineNumber,t.endColumn);return{suggestions:(Array.isArray(e)?e:e.suggestions).map(u=>{var g,h;return Object.assign(Object.assign({},u),{insertText:(g=u.insertText)!==null&&g!==void 0?g:typeof u.label=="string"?u.label:u.label.label,range:(h=u.range)!==null&&h!==void 0?h:l})}),dispose:Array.isArray(e)?void 0:e.dispose,incomplete:Array.isArray(e)?void 0:e.incomplete}})}}function L(i){const s=[],r=[],a=new b(i);s.push(a);const o=(...e)=>a.getLanguageServiceWorker(...e);function n(){const{languageId:e,modeConfiguration:t}=i;c(r),t.diagnostics&&r.push(new m(e,o,i)),t.completionItems.enable&&r.push(v.registerCompletionItemProvider(e,new y(o,i)))}return n(),s.push(p(r)),p(s)}function p(i){return{dispose:()=>c(i)}}function c(i){for(var s;i.length;)(s=i.pop())===null||s===void 0||s.dispose()}export{L as setupLanguageMode};

import{e as a,R as v,l as h,d as f,M as b,W as C}from"./index-654ea203.js";class I{constructor(e,o,i){this._languageId=e,this._worker=o,this._disposables=[],this._listener=Object.create(null);const n=t=>{let s=t.getLanguageId();s===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(f(()=>{this._doValidate(t.uri,s)},600)),this._doValidate(t.uri,s))},l=t=>{a.setModelMarkers(t,this._languageId,[]);let s=t.uri.toString(),u=this._listener[s];u&&(u.dispose(),delete this._listener[s])};this._disposables.push(a.onDidCreateModel(n)),this._disposables.push(a.onWillDisposeModel(l)),this._disposables.push(a.onDidChangeModelLanguage(t=>{l(t.model),n(t.model)})),i.onDidChange(t=>{a.getModels().forEach(s=>{s.getLanguageId()===this._languageId&&(l(s),n(s))})}),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),a.getModels().forEach(n)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,o){this._worker(e).then(i=>{var n;return i.doValidation(((n=a.getModel(e))===null||n===void 0?void 0:n.getValue())||"")}).then(i=>{const n=i.map(t=>k(e,t));let l=a.getModel(e);l&&l.getLanguageId()===o&&a.setModelMarkers(l,o,n)}).then(void 0,i=>{console.error(i)})}}function M(r){switch(r){default:return b.Error}}function k(r,e){let o=typeof e.code=="number"?String(e.code):e.code;return{severity:M(e.severity),startLineNumber:e.startLine,startColumn:e.startCol+1,endLineNumber:e.endLine,endColumn:e.endCol+1,message:e.message,code:o,source:e.source}}class w{constructor(e,o){this._worker=e,this._defaults=o}get triggerCharacters(){return["."," "]}provideCompletionItems(e,o,i,n){const l=e.uri;return this._worker(l).then(t=>{var s;return t.doComplete(((s=a.getModel(l))===null||s===void 0?void 0:s.getValue())||"",o)}).then(t=>{var s;return((s=this._defaults.completionService)!==null&&s!==void 0?s:S)(e,o,i,t)}).then(t=>{const s=e.getWordUntilPosition(o),u=new v(o.lineNumber,s.startColumn,o.lineNumber,s.endColumn);return{suggestions:t.map(d=>{var c,p,g;return Object.assign(Object.assign({},d),{insertText:(c=d.insertText)!==null&&c!==void 0?c:typeof d.label=="string"?d.label:d.label.label,range:(p=d.range)!==null&&p!==void 0?p:u,insertTextRules:(g=d.insertTextRules)!==null&&g!==void 0?g:h.CompletionItemInsertTextRule.InsertAsSnippet})})}})}}const S=function(r,e,o,i){if(!i)return Promise.resolve([]);const{keywords:n}=i,l=n.map(t=>({label:t,kind:h.CompletionItemKind.Keyword,detail:"关键字"}));return Promise.resolve(l)};function D(r){const e=[],o=[],i=new C(r);e.push(i);const n=(...t)=>i.getLanguageServiceWorker(...t);function l(){const{languageId:t,modeConfiguration:s}=r;m(o),s.diagnostics&&o.push(new I(t,n,r)),s.completionItems&&o.push(h.registerCompletionItemProvider(t,new w(n,r)))}return l(),e.push(_(o)),_(e)}function _(r){return{dispose:()=>m(r)}}function m(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{D as setupLanguageMode};

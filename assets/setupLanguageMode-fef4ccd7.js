import{e as p,R as f,M as b,W as y,l as v}from"./index-58dd92b4.js";function w(r,e,o){let s=null;return(...l)=>{if(s&&clearTimeout(s),o&&!s)return r==null?void 0:r(...l);s=setTimeout(()=>{s&&clearTimeout(s),s=null,r==null||r(...l)},e)}}class m{constructor(e,o,s){this._languageId=e,this._worker=o,this._defaults=s,this._disposables=[],this._listener=Object.create(null);const l=n=>{let t=n.getLanguageId();t===this._languageId&&(this._listener[n.uri.toString()]=n.onDidChangeContent(w(()=>{this._doValidate(n.uri,t)},500)),this._doValidate(n.uri,t))},a=n=>{p.setModelMarkers(n,this._languageId,[]);let t=n.uri.toString(),i=this._listener[t];i&&(i.dispose(),delete this._listener[t])};this._disposables.push(p.onDidCreateModel(l)),this._disposables.push(p.onWillDisposeModel(a)),this._disposables.push(p.onDidChangeModelLanguage(n=>{a(n.model),l(n.model)})),this._disposables.push(this._defaults.onDidChange(n=>{p.getModels().forEach(t=>{t.getLanguageId()===this._languageId&&(a(t),l(t))})})),this._disposables.push({dispose:()=>{for(let n in this._listener)this._listener[n].dispose()}}),p.getModels().forEach(l)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,o){this._worker(e).then(s=>{var l;let a=((l=p.getModel(e))===null||l===void 0?void 0:l.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(a=this._defaults.preprocessCode(a)),s.doValidation(a)}).then(s=>{const l=s.map(n=>A(e,n));let a=p.getModel(e);a&&a.getLanguageId()===o&&p.setModelMarkers(a,o,l)}).then(void 0,s=>{console.error(s)})}}function k(r){switch(r){default:return b.Error}}function A(r,e){return{severity:k(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class M{constructor(e,o){this._worker=e,this._defaults=o}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(e,o,s,l){const a=e.uri;return this._worker(a).then(n=>{var t;let i=((t=p.getModel(a))===null||t===void 0?void 0:t.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(i=this._defaults.preprocessCode(i)),n.doCompletionWithEntities(i,o)}).then(({suggestions:n,allEntities:t,context:i})=>{let h=[];return i!=null&&i.isStatementBeginning&&(h=this._defaults.completionSnippets.map(c=>Object.assign(Object.assign({},c),{insertText:typeof c.body=="string"?c.body:c.body.join(`
`)}))),this._defaults.completionService(e,o,s,n,t,h)}).then(n=>{const t=e.getWordUntilPosition(o),i=new f(o.lineNumber,t.startColumn,o.lineNumber,t.endColumn);return{suggestions:(Array.isArray(n)?n:n.suggestions).map(d=>{var u,g;return Object.assign(Object.assign({},d),{insertText:(u=d.insertText)!==null&&u!==void 0?u:typeof d.label=="string"?d.label:d.label.label,range:(g=d.range)!==null&&g!==void 0?g:i})}),dispose:Array.isArray(n)?void 0:n.dispose,incomplete:Array.isArray(n)?void 0:n.incomplete}})}}class I{constructor(e,o){this._worker=e,this._defaults=o}provideDefinition(e,o,s){const l=e.uri;return e.getLineContent(o.lineNumber).startsWith("--")?null:this._worker(l).then(n=>{let t=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(t=this._defaults.preprocessCode(t)),n.getAllEntities(t)}).then(n=>{const t=e.getWordAtPosition(o);let i={line:-1,startIndex:-1,endIndex:-1,startColumn:-1,endColumn:-1};const h=n==null?void 0:n.find(c=>{const d=c.position;return d.startColumn===(t==null?void 0:t.startColumn)&&d.endColumn===(t==null?void 0:t.endColumn)&&d.line===o.lineNumber?c:null});if(h)for(let c in n){const d=n[Number(c)];if(d.entityContextType.includes("Create")&&(t!=null&&t.word)&&d.text===(t==null?void 0:t.word)&&d.entityContextType.includes(h.entityContextType)){i=d.position;break}}if(i&&i.line!==-1)return{uri:e.uri,range:new f(i==null?void 0:i.line,i==null?void 0:i.startColumn,i==null?void 0:i.line,i==null?void 0:i.endColumn)}})}}class x{constructor(e,o){this._worker=e,this._defaults=o}provideReferences(e,o,s,l){const a=e.uri;if(e.getLineContent(o.lineNumber).startsWith("CREATE"))return this._worker(a).then(t=>{let i=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(i=this._defaults.preprocessCode(i)),t.getAllEntities(e==null?void 0:e.getValue())}).then(t=>{const i=e.getWordAtPosition(o),h=[],c=t==null?void 0:t.find(d=>{const u=d.position;return u.startColumn===(i==null?void 0:i.startColumn)&&u.endColumn===(i==null?void 0:i.endColumn)&&u.line===o.lineNumber?d:null});return c&&(t==null||t.forEach(d=>{if(i!=null&&i.word&&d.text===(i==null?void 0:i.word)&&c.entityContextType.includes(d.entityContextType)){let u=null;u=d.position,h.push({uri:e.uri,range:new f(u==null?void 0:u.line,u==null?void 0:u.startColumn,u==null?void 0:u.line,u==null?void 0:u.endColumn)})}})),h})}}function L(r){const e=[],o=[],s=new y(r);e.push(s);const l=(...n)=>s.getLanguageServiceWorker(...n);function a(){const{languageId:n,modeConfiguration:t}=r;C(o),t.diagnostics&&o.push(new m(n,l,r)),t.completionItems.enable&&o.push(v.registerCompletionItemProvider(n,new M(l,r))),t.references&&o.push(v.registerReferenceProvider(n,new x(l,r))),t.definitions&&o.push(v.registerDefinitionProvider(n,new I(l,r)))}return a(),e.push(_(o)),_(e)}function _(r){return{dispose:()=>C(r)}}function C(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{L as setupLanguageMode};
